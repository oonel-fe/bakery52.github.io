<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bakery52 | Pedidos</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600&family=Nerko+One&display=swap" rel="stylesheet">
    <style>
        /* MANTENGO TUS ESTILOS ORIGINALES */
        :root { --bg: #fffaee; --blue: #285cac; --orange: #f74621; --white: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--blue); font-family: 'EB Garamond', serif; margin: 0; padding-bottom: 180px; } 
        h1, h2, h3 { font-family: 'Nerko One', cursive; font-weight: normal; margin: 0; }
        header { text-align: center; padding: 20px; font-size: 1.3em; }
        .logo { max-width: 170px; }
        .cutoff-banner { background: var(--orange); color: white; text-align: center; padding: 12px; position: sticky; top: 0; z-index: 1000; font-family: 'Nerko One'; font-size: 1.1rem; }
        .container { padding: 15px; max-width: 500px; margin: 0 auto; }
        .product-card { background: var(--white); border-radius: 15px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 4px 10px rgba(40,92,172,0.08); border: 1px solid rgba(40,92,172,0.05); }
        .product-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; display: block; }
        .product-info { padding: 20px; }
        .product-info h3 { font-size: 1.8rem; line-height: 1.1; margin-bottom: 5px; } 
        .product-price { color: var(--orange); font-weight: bold; font-size: 1.4rem; }
        .allergens { display: flex; flex-wrap: wrap; gap: 6px; margin: 12px 0; }
        .allergen-tag { font-size: 0.75rem; display: flex; align-items: center; gap: 3px; background: #fdfaf0; padding: 3px 8px; border-radius: 20px; border: 0.5px solid #eee; }
        .qty-selector { display: flex; align-items: center; gap: 15px; justify-content: flex-end; margin-top: 10px; }
        .btn-qty { background: var(--blue); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .order-form { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; border: 1px solid rgba(40,92,172,0.1); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-family: 'EB Garamond'; font-size: 1rem; }
        .sticky-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px 25px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 900; display: flex; flex-direction: column; gap: 10px; }
        .cart-breakdown { font-size: 0.95rem; border-bottom: 1px dashed #ddd; padding-bottom: 10px; max-height: 120px; overflow-y: auto; }
        .breakdown-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: 600; }
        .breakdown-row span:last-child { color: var(--orange); }
        .footer-controls { display: flex; justify-content: space-between; align-items: center; }
        .btn-confirm { background: var(--orange); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-family: 'Nerko One'; font-size: 1.4rem; cursor: pointer; }
        .btn-confirm:disabled { background: #ccc; cursor: not-allowed; }
        .hidden-element { display: none !important; }
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        #gdpr_check { width: auto !important; height: auto !important; margin: 4px 0 0 0 !important; padding: 0 !important; cursor: pointer; }
        #gdpr_check + label { font-size: 0.9rem; line-height: 1.2; cursor: pointer; }
        
        /* NUEVO: Bot√≥n Instagram */
        .btn-instagram { color: #f74621; margin-top: 25px; font-family: 'Nerko One'; font-size: 1.2rem; text-decoration: none; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>

<div id="cutoff-banner" class="cutoff-banner hidden-element">
    ‚ö†Ô∏è PEDIDOS CERRADOS. Volvemos el pr√≥ximo lunes.
</div>

<header>
    <img src="https://i.postimg.cc/ryhHFM2M/Logo-naranjo-sin-fondo.png" alt="Logo Bakery52" class="logo">
    <p style="margin-top:5px; font-style: italic;">Pan artesanal ¬∑ Tenemos capacidad limitada, ¬°no esperes a √∫ltima hora!</p>
</header>

<div class="container">
    <div id="catalog"></div>

    <div class="order-form" id="main-form">
        <h2 style="margin-top:0">Datos para retirar (Viernes)</h2>
        <input type="text" id="name" placeholder="Tu nombre completo *" required>
        <input type="tel" id="phone" placeholder="WhatsApp (ej: 600123456) *" required>
        <select id="pickupTime" required>
            <option value="">¬øA qu√© hora pasas el viernes? (aprox.) *</option>
            <option value="13:00">13:00h</option>
            <option value="14:00">14:00h</option>
            <option value="15:00">15:00h</option>
            <option value="16:00">16:00h</option>
            <option value="17:00">17:00h</option>
            <option value="18:00">18:00h</option>
        </select>
        <textarea id="notes" rows="2" placeholder="Notas (ej: Sin s√©samo)"></textarea>
        <div class="gdpr" style="font-size: 0.85rem; display: flex; gap: 8px; margin-top: 10px; align-items: flex-start;">
           <input type="checkbox" id="gdpr_check" required>
            <label for="gdpr_check">Acepto que Bakery52 gestione mis datos para confirmar este pedido e informarme.</label>
        </div>
    </div>
</div>

<div class="sticky-bar" id="sticky-cart">
    <div id="cart-breakdown" class="cart-breakdown hidden-element"></div>
    <div class="footer-controls">
        <div>
            <small>Total pedido</small>
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--blue)" id="total-val">0,00‚Ç¨</div>
        </div>
        <button class="btn-confirm" id="submit-btn" onclick="sendOrder()" disabled>Confirmar</button>
    </div>
</div>

<div id="success-screen" class="overlay" style="display: none;">
    <h1 style="color:var(--orange); font-size: 3rem; line-height:0.9">¬°Pedido registrado!</h1>
    <p style="margin-top:20px">Pulsa el bot√≥n para enviar el detalle por WhatsApp y gestionar el pago.</p>
    <br>
    <button class="btn-confirm" id="wa-final-btn" style="width: 100%; max-width: 280px;">ENVIAR WHATSAPP</button>
    
    <a href="https://www.instagram.com/bakery52.es" target="_blank" class="btn-instagram">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
        Sigue nuestro horneado en Instagram
    </a>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzWfCT1Mw5bAf9igf22zTdoCADkrEs6XDiWcaf0fSU_1_6FnwoHgt8gNE5u4v4OcFEE2g/exec"; // <--- PON TU URL AQU√ç
    
    const products = [
        { id: 'jm', name: 'Jal√° M', price: 4.5, packPrice: 8.5, img: 'NFqqD5WQ/Jala-artesanal-M.png', desc1: 'Jal√° artesanal con s√©samo y avena (340g)*.', desc2: '¬°Llevando 2 pagas solo 8,50‚Ç¨!' },
        { id: 'jl', name: 'Jal√° L', price: 6.5, packPrice: 12.0, img: '8cR80TSQ/Jala-artesanal-L.png', desc1: 'Jal√° artesanal con s√©samo y avena (630g)*.', desc2: 'Llevando 2 pagas solo 12,00‚Ç¨!' },
        { id: 'jxl', name: 'Jal√° XL', price: 9.0, packPrice: 16.5, img: 'wMXKG9pd/Jala-artesanal-XL.png', desc1: 'Jal√° artesanal con s√©samo y avena (920g)*.', desc2: '¬°Llevando 2 pagas solo 16,50‚Ç¨!' }
    ];

    const allergenList = [{e:'üåæ', n:'Gluten'}, {e:'ü•ö', n:'Huevo'}, {e:'ü•®', n:'S√©samo'}, {e:'ü•£', n:'Avena'}];
    let cart = {};

    function renderCatalog() {
        const cat = document.getElementById('catalog');
        products.forEach(p => {
            cat.innerHTML += `<div class="product-card">
                <img src="https://i.postimg.cc/${p.img}" class="product-img">
                <div class="product-info">
                    <h3>${p.name}</h3>
                    <span class="product-price">${p.price.toFixed(2)}‚Ç¨</span>
                    <p style="font-size:1.1rem; color:#285CAC; margin: 8px 0;">${p.desc1}</p>
                    <p style="font-size:1.1rem; font-weight: bold; color:#285CAC; margin: 8px 0;">${p.desc2}</p>
                    <div class="allergens">${allergenList.map(a => `<span class="allergen-tag">${a.e} <small>${a.n}</small></span>`).join('')}</div>
                    <div class="qty-selector">
                        <button class="btn-qty" onclick="changeQty('${p.id}', -1)">-</button>
                        <span id="q-${p.id}" style="min-width:40px; text-align:center; font-weight:bold; font-size:1.4rem;">0</span>
                        <button class="btn-qty" onclick="changeQty('${p.id}', 1)">+</button>
                    </div>
                </div>
            </div>`;
        });
        checkStatus();
    }

    function changeQty(id, delta) {
        cart[id] = (cart[id] || 0) + delta;
        if (cart[id] < 0) cart[id] = 0;
        document.getElementById(`q-${id}`).innerText = cart[id];
        calculateCart();
    }

    function calculateCart() {
        let total = 0; let breakdownHTML = ""; let hasItems = false;
        products.forEach(p => {
            const qty = cart[p.id] || 0;
            if (qty > 0) {
                hasItems = true;
                const numPacks = Math.floor(qty / 2); const numSingles = qty % 2;
                if (numPacks > 0) {
                    total += (numPacks * p.packPrice);
                    breakdownHTML += `<div class="breakdown-row"><span>${numPacks} Pack(s) ${p.name}</span> <span>${(numPacks * p.packPrice).toFixed(2)}‚Ç¨</span></div>`;
                }
                if (numSingles > 0) {
                    total += (numSingles * p.price);
                    breakdownHTML += `<div class="breakdown-row"><span>1 ${p.name}</span> <span>${p.price.toFixed(2)}‚Ç¨</span></div>`;
                }
            }
        });
        document.getElementById('cart-breakdown').innerHTML = breakdownHTML;
        document.getElementById('cart-breakdown').className = hasItems ? 'cart-breakdown' : 'hidden-element';
        document.getElementById('total-val').innerText = total.toFixed(2).replace('.', ',') + '‚Ç¨';
        document.getElementById('submit-btn').disabled = !hasItems || document.getElementById('submit-btn').innerText === "Cerrado";
    }

    async function checkStatus() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            const banner = document.getElementById('cutoff-banner');
            const btn = document.getElementById('submit-btn');

            if (!data.open) {
                banner.classList.remove('hidden-element');
                btn.disabled = true; btn.innerText = "Cerrado";
                if(data.reason === "STOCK") {
                    banner.innerText = "¬°Sold Out! Producci√≥n completada para esta semana. Te avisaremos el pr√≥ximo lunes.";
                }
            }
        } catch(e) { console.log("Error checking status"); }
    }

    function validatePhone(phone) {
        const regex = /^(?:\+34|34)?[6789]\d{8}$/;
        return regex.test(phone.replace(/\s/g, ''));
    }

    async function sendOrder() {
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const time = document.getElementById('pickupTime').value;
        const gdpr = document.getElementById('gdpr_check').checked;

        if(!name || !time || !gdpr) { alert("Por favor, rellena los campos obligatorios."); return; }
        if(!validatePhone(phone)) { alert("Por favor, introduce un n√∫mero de tel√©fono v√°lido."); return; }

        const btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.innerText = "Registrando...";

        let summary = [];
        products.forEach(p => {
            const qty = cart[p.id] || 0;
            if (qty > 0) {
                const nP = Math.floor(qty / 2); const nS = qty % 2;
                if(nP > 0) summary.push(`${nP} Pack(s) ${p.name}`);
                if(nS > 0) summary.push(`1 ${p.name}`);
            }
        });

        const data = {
            nombre: name, telefono: phone, dia: "Viernes", hora: time,
            notas: document.getElementById('notes').value,
            total: document.getElementById('total-val').innerText,
            items: summary.join(' + ')
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            showSuccess(data, summary);
        } catch (e) { showSuccess(data, summary); }
    }

    function showSuccess(data, summary) {
        document.getElementById('success-screen').style.display = 'flex';
        const msg = `Hola Bakery52! Soy ${data.nombre}.%0AQuiero confirmar mi pedido para el *Viernes* a las *${data.hora}h*:%0A${summary.map(s => '- ' + s).join('%0A')}%0A%0ATotal: ${data.total}%0ANotas: ${data.notes || 'Ninguna'}`;
        document.getElementById('wa-final-btn').onclick = () => window.open(`https://wa.me/34606700154?text=${msg}`, '_blank');
    }

    renderCatalog();
</script>
</body>
</html>
